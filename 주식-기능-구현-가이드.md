# 주식 포트폴리오 기능 구현 가이드

## 📊 개요

가계부 앱에 **주식 보유 현황 및 평가금액** 기능을 추가하는 가이드입니다.

**핵심 기능**:
- 보유 주식 등록 (종목, 매입가, 수량)
- 실시간 현재가 조회 (API)
- 평가금액 자동 계산
- 수익/손실률 표시

---

## 💰 비용: 100% 무료 ✅

### 무료로 사용 가능한 API

#### 1. 한국 주식 - 한국투자증권 KIS Developers (추천)

**가격**: 완전 무료
**제공**: 한국투자증권
**제한**:
- 하루 100,000건 조회 가능
- 분당 20건 조회 가능
- 충분히 넉넉함!

**등록 방법**:
1. https://apiportal.koreainvestment.com/ 접속
2. 회원가입 (무료)
3. 앱 등록
4. API Key 발급 (무료)

**제공 데이터**:
- 실시간 주식 시세
- 종목 검색
- 과거 시세 조회
- 전일 종가, 시가, 고가, 저가

---

#### 2. 미국 주식 - Alpha Vantage

**가격**: 완전 무료
**제한**:
- 하루 25건 조회
- 분당 5건 조회

**등록 방법**:
1. https://www.alphavantage.co/support/#api-key 접속
2. 이메일 입력
3. 무료 API Key 즉시 발급

**제공 데이터**:
- 실시간 주식 시세
- 글로벌 주식 (미국, 한국 포함)
- 환율 정보

---

#### 3. 미국 주식 - Yahoo Finance (비공식)

**가격**: 완전 무료
**제한**: 거의 없음
**주의**: 비공식 API라서 언제든 막힐 수 있음

**사용 방법**:
- npm 패키지 사용: `yahoo-finance2`
- API Key 불필요

---

## 🏗️ 구현 아키텍처

### 데이터 구조

```javascript
// Firebase Database 구조
users/{userId}/
└── stocks/
    └── {stockId}/
        ├── id: Number (타임스탬프)
        ├── symbol: String (종목코드, 예: "005930" 삼성전자)
        ├── name: String (종목명, 예: "삼성전자")
        ├── market: String ("KR" | "US")
        ├── quantity: Number (보유 수량)
        ├── buyPrice: Number (매입가)
        ├── buyDate: String (매입일, "YYYY-MM-DD")
        ├── memo: String (메모, 선택)
        └── userId: String ("user1" | "user2")
```

### 파일 구조

```
src/
├── constants/
│   └── stocks.js                # 주식 관련 상수
├── services/
│   ├── stockApiService.js       # API 호출 서비스
│   └── stockCalculationService.js # 계산 로직
├── hooks/
│   └── useStocks.js             # 주식 데이터 관리 훅
├── firebase/
│   └── databaseService.js       # 주식 CRUD 추가
├── components/
│   └── stock/
│       ├── StockForm.js         # 주식 등록/수정 폼
│       ├── StockCard.js         # 주식 카드 (개별)
│       └── StockSummary.js      # 포트폴리오 요약
└── pages/
    └── StockPage.js             # 주식 페이지
```

---

## 📝 구현 단계

### Phase 1: 기본 UI 구현 (1시간)

#### 1.1 상수 정의

```javascript
// src/constants/stocks.js
export const STOCK_MARKETS = {
  KR: { label: '한국', icon: '🇰🇷' },
  US: { label: '미국', icon: '🇺🇸' }
};

export const POPULAR_STOCKS = {
  KR: [
    { symbol: '005930', name: '삼성전자' },
    { symbol: '000660', name: 'SK하이닉스' },
    { symbol: '035420', name: 'NAVER' },
    { symbol: '005380', name: '현대차' }
  ],
  US: [
    { symbol: 'AAPL', name: 'Apple' },
    { symbol: 'MSFT', name: 'Microsoft' },
    { symbol: 'GOOGL', name: 'Google' },
    { symbol: 'TSLA', name: 'Tesla' }
  ]
};
```

#### 1.2 StockPage 생성

```javascript
// src/pages/StockPage.js
import React, { useState } from 'react';
import { Plus } from 'lucide-react';
import { Button } from '../components/common';

export const StockPage = ({ stocks, onAddStock, onUpdateStock, onDeleteStock }) => {
  const [showForm, setShowForm] = useState(false);

  return (
    <div className="p-4 sm:p-8 space-y-6">
      {/* 헤더 */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">주식 포트폴리오</h1>
        <Button
          variant="primary"
          icon={Plus}
          onClick={() => setShowForm(true)}
        >
          주식 추가
        </Button>
      </div>

      {/* 포트폴리오 요약 */}
      <StockSummary stocks={stocks} />

      {/* 주식 목록 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {stocks.map(stock => (
          <StockCard
            key={stock.id}
            stock={stock}
            onUpdate={onUpdateStock}
            onDelete={onDeleteStock}
          />
        ))}
      </div>

      {/* 주식 등록 폼 모달 */}
      {showForm && (
        <StockForm
          onSubmit={onAddStock}
          onClose={() => setShowForm(false)}
        />
      )}
    </div>
  );
};
```

#### 1.3 Sidebar 메뉴 추가

```javascript
// src/components/layout/Sidebar.js
import { TrendingUp } from 'lucide-react'; // 추가

const menuItems = [
  { id: 'calendar', icon: Calendar, label: '달력', color: 'text-blue-600' },
  { id: 'statistics', icon: BarChart3, label: '통계', color: 'text-purple-600' },
  { id: 'stocks', icon: TrendingUp, label: '주식', color: 'text-indigo-600' }, // 추가
  { id: 'fixed', icon: Repeat, label: '고정지출', color: 'text-green-600' },
  { id: 'search', icon: Search, label: '검색', color: 'text-orange-600' },
  { id: 'settings', icon: Settings, label: '설정', color: 'text-gray-600' }
];
```

---

### Phase 2: Firebase 연동 (30분)

#### 2.1 Database Service 확장

```javascript
// src/firebase/databaseService.js
// 주식 CRUD 함수 추가

// 주식 저장
export const saveStock = async (userId, stockData) => {
  try {
    const stockRef = ref(database, `users/${userId}/stocks/${stockData.id}`);
    await set(stockRef, stockData);
    console.log('✅ 주식 저장 성공:', stockData.name);
  } catch (error) {
    console.error('❌ 주식 저장 실패:', error);
    throw error;
  }
};

// 주식 목록 가져오기
export const getStocks = async (userId) => {
  try {
    const stocksRef = ref(database, `users/${userId}/stocks`);
    const snapshot = await get(stocksRef);

    if (snapshot.exists()) {
      const stocksObject = snapshot.val();
      return Object.values(stocksObject);
    }
    return [];
  } catch (error) {
    console.error('❌ 주식 가져오기 실패:', error);
    return [];
  }
};

// 주식 실시간 리스너
export const onStocksChange = (userId, callback) => {
  const stocksRef = ref(database, `users/${userId}/stocks`);

  const unsubscribe = onValue(stocksRef, (snapshot) => {
    if (snapshot.exists()) {
      const stocksObject = snapshot.val();
      const stocksArray = Object.values(stocksObject);
      callback(stocksArray);
    } else {
      callback([]);
    }
  });

  return unsubscribe;
};

// 주식 삭제
export const deleteStock = async (userId, stockId) => {
  try {
    const stockRef = ref(database, `users/${userId}/stocks/${stockId}`);
    await remove(stockRef);
    console.log('✅ 주식 삭제 성공');
  } catch (error) {
    console.error('❌ 주식 삭제 실패:', error);
    throw error;
  }
};
```

#### 2.2 useStocks 훅 생성

```javascript
// src/hooks/useStocks.js
import { useState, useEffect } from 'react';
import { saveStock, deleteStock as deleteStockDB, onStocksChange } from '../firebase/databaseService';

export const useStocks = (currentUser) => {
  const [stocks, setStocks] = useState([]);
  const [loading, setLoading] = useState(true);

  // Firebase 실시간 리스너
  useEffect(() => {
    if (!currentUser?.firebaseId) {
      setStocks([]);
      setLoading(false);
      return;
    }

    const unsubscribe = onStocksChange(currentUser.firebaseId, (stocksData) => {
      setStocks(stocksData);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [currentUser]);

  // 주식 추가
  const addStock = async (stockData) => {
    try {
      const newStock = {
        id: Date.now(),
        ...stockData,
        userId: currentUser.id
      };

      await saveStock(currentUser.firebaseId, newStock);
    } catch (error) {
      alert('주식 추가 실패: ' + error.message);
    }
  };

  // 주식 삭제
  const deleteStock = async (stockId) => {
    try {
      await deleteStockDB(currentUser.firebaseId, stockId);
    } catch (error) {
      alert('주식 삭제 실패: ' + error.message);
    }
  };

  return {
    stocks,
    loading,
    addStock,
    deleteStock
  };
};
```

---

### Phase 3: API 연동 (1시간)

#### 3.1 환경 변수 설정

```env
# .env
# 기존 Firebase 설정...

# 주식 API
REACT_APP_KIS_APP_KEY=your_kis_app_key
REACT_APP_KIS_APP_SECRET=your_kis_app_secret
REACT_APP_ALPHAVANTAGE_API_KEY=your_alphavantage_key
```

#### 3.2 API 서비스 구현

```javascript
// src/services/stockApiService.js
const KIS_APP_KEY = process.env.REACT_APP_KIS_APP_KEY;
const KIS_APP_SECRET = process.env.REACT_APP_KIS_APP_SECRET;
const ALPHAVANTAGE_KEY = process.env.REACT_APP_ALPHAVANTAGE_API_KEY;

// 한국 주식 현재가 조회 (KIS API)
export const getKoreanStockPrice = async (symbol) => {
  try {
    // 1. 토큰 발급 (최초 1회)
    const tokenResponse = await fetch('https://openapi.koreainvestment.com:9443/oauth2/tokenP', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        grant_type: 'client_credentials',
        appkey: KIS_APP_KEY,
        appsecret: KIS_APP_SECRET
      })
    });

    const tokenData = await tokenResponse.json();
    const accessToken = tokenData.access_token;

    // 2. 주식 현재가 조회
    const priceResponse = await fetch(
      `https://openapi.koreainvestment.com:9443/uapi/domestic-stock/v1/quotations/inquire-price?fid_cond_mrkt_div_code=J&fid_input_iscd=${symbol}`,
      {
        headers: {
          'Content-Type': 'application/json',
          'authorization': `Bearer ${accessToken}`,
          'appkey': KIS_APP_KEY,
          'appsecret': KIS_APP_SECRET,
          'tr_id': 'FHKST01010100'
        }
      }
    );

    const priceData = await priceResponse.json();

    return {
      symbol,
      currentPrice: parseInt(priceData.output.stck_prpr), // 현재가
      changeRate: parseFloat(priceData.output.prdy_ctrt), // 등락률
      changeAmount: parseInt(priceData.output.prdy_vrss) // 전일대비
    };
  } catch (error) {
    console.error('❌ 한국 주식 조회 실패:', error);
    throw error;
  }
};

// 미국 주식 현재가 조회 (Alpha Vantage)
export const getUSStockPrice = async (symbol) => {
  try {
    const response = await fetch(
      `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHAVANTAGE_KEY}`
    );

    const data = await response.json();
    const quote = data['Global Quote'];

    return {
      symbol,
      currentPrice: parseFloat(quote['05. price']),
      changeRate: parseFloat(quote['10. change percent'].replace('%', '')),
      changeAmount: parseFloat(quote['09. change'])
    };
  } catch (error) {
    console.error('❌ 미국 주식 조회 실패:', error);
    throw error;
  }
};

// 통합 함수
export const getStockPrice = async (symbol, market) => {
  if (market === 'KR') {
    return getKoreanStockPrice(symbol);
  } else if (market === 'US') {
    return getUSStockPrice(symbol);
  }
  throw new Error('지원하지 않는 시장입니다.');
};
```

#### 3.3 계산 서비스 구현

```javascript
// src/services/stockCalculationService.js

// 평가금액 계산
export const calculateStockValue = (stock, currentPrice) => {
  return stock.quantity * currentPrice;
};

// 수익/손실 계산
export const calculateProfit = (stock, currentPrice) => {
  const buyValue = stock.quantity * stock.buyPrice;
  const currentValue = stock.quantity * currentPrice;
  return currentValue - buyValue;
};

// 수익률 계산
export const calculateProfitRate = (stock, currentPrice) => {
  const profit = calculateProfit(stock, currentPrice);
  const buyValue = stock.quantity * stock.buyPrice;
  return (profit / buyValue) * 100;
};

// 포트폴리오 전체 통계
export const calculatePortfolioStats = (stocks, currentPrices) => {
  let totalBuyValue = 0;
  let totalCurrentValue = 0;

  stocks.forEach(stock => {
    const currentPrice = currentPrices[stock.symbol] || stock.buyPrice;
    totalBuyValue += stock.quantity * stock.buyPrice;
    totalCurrentValue += stock.quantity * currentPrice;
  });

  const totalProfit = totalCurrentValue - totalBuyValue;
  const totalProfitRate = (totalProfit / totalBuyValue) * 100;

  return {
    totalBuyValue,      // 총 매입금액
    totalCurrentValue,  // 총 평가금액
    totalProfit,        // 총 손익
    totalProfitRate     // 총 수익률
  };
};
```

---

### Phase 4: UI 컴포넌트 구현 (1시간)

#### 4.1 StockCard 컴포넌트

```javascript
// src/components/stock/StockCard.js
import React, { useState, useEffect } from 'react';
import { TrendingUp, TrendingDown } from 'lucide-react';
import { getStockPrice } from '../../services/stockApiService';
import { calculateProfit, calculateProfitRate } from '../../services/stockCalculationService';

export const StockCard = ({ stock, onDelete }) => {
  const [currentPrice, setCurrentPrice] = useState(null);
  const [loading, setLoading] = useState(true);

  // 현재가 조회
  useEffect(() => {
    const fetchPrice = async () => {
      try {
        const priceData = await getStockPrice(stock.symbol, stock.market);
        setCurrentPrice(priceData.currentPrice);
      } catch (error) {
        console.error('가격 조회 실패:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchPrice();

    // 5분마다 자동 업데이트
    const interval = setInterval(fetchPrice, 5 * 60 * 1000);
    return () => clearInterval(interval);
  }, [stock.symbol, stock.market]);

  if (loading) {
    return <div className="glass-effect p-4 rounded-xl">로딩 중...</div>;
  }

  const profit = calculateProfit(stock, currentPrice);
  const profitRate = calculateProfitRate(stock, currentPrice);
  const isProfit = profit >= 0;

  return (
    <div className="glass-effect p-4 rounded-xl space-y-3">
      {/* 종목명 */}
      <div className="flex justify-between items-start">
        <div>
          <h3 className="font-bold text-lg">{stock.name}</h3>
          <p className="text-sm text-gray-600">{stock.symbol}</p>
        </div>
        <span className="text-xs px-2 py-1 bg-gray-100 rounded">
          {stock.market === 'KR' ? '🇰🇷 한국' : '🇺🇸 미국'}
        </span>
      </div>

      {/* 보유 수량 */}
      <div className="text-sm text-gray-600">
        보유: {stock.quantity.toLocaleString()}주
      </div>

      {/* 가격 정보 */}
      <div className="grid grid-cols-2 gap-2 text-sm">
        <div>
          <p className="text-gray-600">매입가</p>
          <p className="font-semibold">{stock.buyPrice.toLocaleString()}원</p>
        </div>
        <div>
          <p className="text-gray-600">현재가</p>
          <p className="font-semibold">{currentPrice?.toLocaleString()}원</p>
        </div>
      </div>

      {/* 평가금액 */}
      <div className="pt-3 border-t">
        <p className="text-sm text-gray-600">평가금액</p>
        <p className="text-2xl font-bold">
          {(stock.quantity * currentPrice).toLocaleString()}원
        </p>
      </div>

      {/* 수익/손실 */}
      <div className={`flex items-center gap-2 ${isProfit ? 'text-red-600' : 'text-blue-600'}`}>
        {isProfit ? <TrendingUp size={20} /> : <TrendingDown size={20} />}
        <span className="font-semibold">
          {isProfit ? '+' : ''}{profit.toLocaleString()}원 ({profitRate.toFixed(2)}%)
        </span>
      </div>

      {/* 삭제 버튼 */}
      <button
        onClick={() => onDelete(stock.id)}
        className="w-full py-2 text-sm text-red-600 hover:bg-red-50 rounded transition"
      >
        삭제
      </button>
    </div>
  );
};
```

---

## 🚀 실행 방법

### 1. API 키 발급

**한국투자증권 KIS** (한국 주식):
1. https://apiportal.koreainvestment.com/ 회원가입
2. 앱 등록
3. APP KEY, APP SECRET 복사

**Alpha Vantage** (미국 주식):
1. https://www.alphavantage.co/support/#api-key
2. 이메일 입력
3. API Key 복사

### 2. .env 파일 설정

```env
REACT_APP_KIS_APP_KEY=복사한_APP_KEY
REACT_APP_KIS_APP_SECRET=복사한_APP_SECRET
REACT_APP_ALPHAVANTAGE_API_KEY=복사한_API_KEY
```

### 3. 개발 서버 재시작

```bash
npx kill-port 3000
npm start
```

---

## ⚠️ 주의사항

### API 호출 제한

**한국투자증권**:
- 하루 100,000건
- 분당 20건
- 충분히 넉넉함

**Alpha Vantage**:
- 하루 25건 (무료)
- 분당 5건
- 주식 많으면 부족할 수 있음

### 해결 방법

1. **캐싱 사용**:
   ```javascript
   // 5분마다만 API 호출
   const interval = setInterval(fetchPrice, 5 * 60 * 1000);
   ```

2. **Firebase에 저장**:
   ```javascript
   // 마지막 조회 가격을 Firebase에 저장
   // API 호출 실패 시 저장된 가격 사용
   ```

3. **장 마감 시간 체크**:
   ```javascript
   const isMarketOpen = () => {
     const now = new Date();
     const hour = now.getHours();
     // 한국 주식: 평일 9시~15시30분
     // 미국 주식: 한국시간 23시30분~6시
   };
   ```

---

## 📊 예상 결과

### 주식 페이지 화면

```
┌─────────────────────────────────────┐
│  주식 포트폴리오        [주식 추가]  │
├─────────────────────────────────────┤
│  💰 포트폴리오 요약                  │
│  총 평가금액: 12,450,000원           │
│  총 수익:     +1,450,000원 (+13.2%) │
└─────────────────────────────────────┘

┌─────────────┬─────────────┬─────────────┐
│  삼성전자    │  SK하이닉스  │  NAVER      │
│  🇰🇷 한국     │  🇰🇷 한국     │  🇰🇷 한국     │
│  보유: 10주  │  보유: 5주   │  보유: 3주   │
│  평가: 750K  │  평가: 600K  │  평가: 540K  │
│  📈 +5.2%   │  📈 +8.1%   │  📉 -2.3%   │
└─────────────┴─────────────┴─────────────┘
```

---

## 🎯 다음 단계 (선택)

- [ ] 차트 추가 (Chart.js, Recharts)
- [ ] 목표가 알림
- [ ] 매매 기록 (언제 샀는지, 팔았는지)
- [ ] 배당금 계산
- [ ] 포트폴리오 분석 (섹터별, 국가별)

---

**작성일**: 2025-10-16
**비용**: 100% 무료 ✅
**예상 개발 시간**: 3~4시간
