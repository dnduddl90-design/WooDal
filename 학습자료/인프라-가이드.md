# 인프라 & 배포 가이드

> PWA 전환, Service Worker, Git 자동화 전략

**작성일**: 2025-10-15
**난이도**: ⭐⭐⭐ (중급)
**소요 시간**: 약 2시간

---

## 📋 목차

1. [PWA 자동 업데이트](#1-pwa-자동-업데이트)
2. [Git 자동화 전략](#2-git-자동화-전략)

---

## 1. PWA 자동 업데이트

### 개요

**Progressive Web App (PWA)**는 웹과 네이티브 앱의 장점을 결합한 기술입니다.

**핵심 기능**:
- 오프라인 지원
- 홈 화면에 설치 가능
- 백그라운드 동기화
- **자동 업데이트** ⭐

### Service Worker 라이프사이클

```
[1] 설치 (Install)
   - 첫 방문 시 Service Worker 등록
   - 정적 자산 캐싱 (HTML, CSS, JS)
   ↓
[2] 활성화 (Activate)
   - 이전 버전 캐시 삭제
   - 새 Service Worker 활성화
   ↓
[3] 대기 (Waiting)
   - 새 버전 감지
   - 모든 탭 닫을 때까지 대기
   ↓
[4] 업데이트
   - skipWaiting() 호출
   - 즉시 새 버전 활성화
```

### 구현: Service Worker 자동 업데이트

#### 파일: `public/service-worker.js`

```javascript
const CACHE_NAME = 'woodal-budget-v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/static/css/main.css',
  '/static/js/main.js'
];

// 설치 이벤트
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
      .then(() => self.skipWaiting())  // ⭐ 즉시 활성화
  );
});

// 활성화 이벤트
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cache => {
          if (cache !== CACHE_NAME) {
            return caches.delete(cache);  // 이전 캐시 삭제
          }
        })
      );
    }).then(() => self.clients.claim())
  );
});

// Fetch 이벤트 (오프라인 지원)
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
  );
});
```

#### 파일: `src/index.js` (Service Worker 등록)

```javascript
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(registration => {
      console.log('✅ Service Worker 등록 성공');

      // 업데이트 체크
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;

        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // 새 버전 발견!
            if (confirm('새 버전이 있습니다. 지금 업데이트하시겠습니까?')) {
              newWorker.postMessage({ action: 'skipWaiting' });
              window.location.reload();
            }
          }
        });
      });
    })
    .catch(error => console.error('❌ Service Worker 등록 실패:', error));
}
```

### 학습 포인트

1. **skipWaiting()**: 대기 중인 Service Worker를 즉시 활성화
2. **clients.claim()**: 모든 클라이언트에 즉시 적용
3. **updatefound 이벤트**: 새 버전 감지
4. **캐시 버전 관리**: `CACHE_NAME` 변경 시 자동 업데이트

### PWA vs 네이티브 앱 업데이트 비교

| 항목 | 네이티브 앱 | PWA |
|------|-------------|-----|
| **업데이트 방식** | 앱스토어 심사 필요 | 즉시 배포 가능 |
| **사용자 동의** | 필수 | 자동 (백그라운드) |
| **소요 시간** | 1-7일 (심사) | 1분 (배포만) |
| **용량** | 수십 MB | 수백 KB |

---

## 2. Git 자동화 전략

### 개요

개발 중 **Git 커밋/푸시를 자동화**하여 작업 흐름을 개선합니다.

### 3가지 전략 비교

| 전략 | 장점 | 단점 | 추천 대상 |
|------|------|------|-----------|
| **수동** | 커밋 메시지 정교 | 번거로움 | 대형 프로젝트 |
| **Phase 기반** | 의미 있는 단위 | 일부 수동 | 중소형 프로젝트 ⭐ |
| **실시간** | 완전 자동 | 커밋 많음 | 개인 실험 프로젝트 |

### Phase 기반 자동화 (권장)

#### 단계별 구현

**Phase 1: 설계**
```bash
git add .
git commit -m "Phase 1: 프로젝트 초기 설계

- 폴더 구조 생성
- 상수 파일 정의 (categories, users)
- 기본 컴포넌트 스켈레톤
"
git push
```

**Phase 2: 핵심 기능**
```bash
git add .
git commit -m "Phase 2: 거래 관리 기능 구현

- TransactionForm 컴포넌트
- useTransactions 훅
- Firebase CRUD 연동
"
git push
```

**Phase 3: 추가 기능**
```bash
git add .
git commit -m "Phase 3: 통계 페이지 추가

- StatisticsPage 구현
- 월별 집계 로직
- 차트 시각화
"
git push
```

### 커밋 메시지 템플릿

```
[분류] 제목 (50자 이내)

상세 설명:
- 변경 사항 1
- 변경 사항 2
- 변경 사항 3

관련 이슈: #123
```

**분류 예시**:
- `feat`: 새 기능
- `fix`: 버그 수정
- `refactor`: 리팩토링
- `docs`: 문서 수정
- `style`: 코드 포맷팅
- `test`: 테스트 추가

### Git Hooks 활용

#### Pre-commit Hook (커밋 전 자동 검사)

**파일**: `.git/hooks/pre-commit`

```bash
#!/bin/sh

# ESLint 검사
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ ESLint 에러 발견. 커밋 취소."
  exit 1
fi

# 빌드 테스트
npm run build
if [ $? -ne 0 ]; then
  echo "❌ 빌드 실패. 커밋 취소."
  exit 1
fi

echo "✅ Pre-commit 검사 통과"
exit 0
```

#### Post-commit Hook (커밋 후 자동 푸시)

**파일**: `.git/hooks/post-commit`

```bash
#!/bin/sh

# 특정 브랜치에서만 자동 푸시
BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$BRANCH" = "main" ]; then
  echo "🚀 main 브랜치 - 자동 푸시 시작..."
  git push origin main
else
  echo "⏭️ $BRANCH 브랜치 - 수동 푸시 필요"
fi
```

### 하이브리드 접근법 (권장)

```
개발 단계       │ 전략           │ 주기
────────────────┼────────────────┼─────────────
초기 설계       │ Phase 기반     │ 큰 단위 (1일)
핵심 기능 개발  │ Phase 기반     │ 기능별 (2-4시간)
버그 수정       │ 수동           │ 즉시 (발견 시)
리팩토링        │ Phase 기반     │ 모듈별
문서 작업       │ 실시간         │ 수정 즉시
```

### 학습 포인트

1. **의미 있는 단위**: Phase는 논리적 작업 단위
2. **Git Hooks**: 자동화 + 품질 관리 동시 달성
3. **브랜치 전략**: main/develop/feature 분리
4. **커밋 메시지**: 미래의 나를 위한 문서

---

## 마무리

### 구현 완료 체크리스트

**PWA**:
- [x] Service Worker 등록
- [x] 캐시 전략 구현
- [x] 자동 업데이트 알림
- [x] Manifest 파일 작성

**Git 자동화**:
- [x] Phase 기반 커밋 전략
- [x] Pre-commit Hook 설정
- [x] Post-commit Hook 설정
- [x] 커밋 메시지 템플릿

### 핵심 개념 요약

1. **PWA**: skipWaiting() + clients.claim()로 즉시 업데이트
2. **Service Worker**: Install → Activate → Fetch 라이프사이클
3. **Git Phase**: 의미 있는 단위로 자동화
4. **Git Hooks**: 커밋 전후 자동 검사/배포

### 다음 단계

- Firebase Security Rules 설정
- CI/CD 파이프라인 구축 (GitHub Actions)
- 성능 모니터링 (Lighthouse)
- 에러 추적 (Sentry)

---

**작성자**: Claude Code
**버전**: 2.0 (통합)
**라이선스**: MIT
