/**
 * ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
 *
 * ì‚¬ìš©ë²•:
 * 1. ì•± ë¡œê·¸ì¸ (http://localhost:3000 ë˜ëŠ” https://woodal-budget.web.app)
 * 2. F12 â†’ Console íƒ­
 * 3. ì•„ë˜ ì½”ë“œ ì „ì²´ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°
 * 4. Enter í‚¤
 */

// =================================================================
// ì—¬ê¸°ì„œë¶€í„° ë³µì‚¬ ì‹œì‘
// =================================================================

(async function() {
  console.log('ğŸ”„ user1 â†’ Firebase UID ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');

  // Firebase ì•± ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ë¡œë“œëœ ìƒíƒœ)
  const { getDatabase, ref, get, update } = window.firebaseImports || {};

  if (!getDatabase) {
    console.error('âŒ Firebaseê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    return;
  }

  const database = getDatabase();

  // í˜„ì¬ Firebase ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
  const { getAuth } = window.firebaseImports || {};
  const auth = getAuth();
  const currentUser = auth.currentUser;

  if (!currentUser) {
    console.error('âŒ ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    return;
  }

  const firebaseId = currentUser.uid;
  console.log(`ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: ${currentUser.email}`);
  console.log(`ğŸ”‘ Firebase UID: ${firebaseId}`);

  try {
    // 1. ê°€ì¡± ID í™•ì¸
    const familyIdSnapshot = await get(ref(database, `users/${firebaseId}/familyId`));
    const familyId = familyIdSnapshot.exists() ? familyIdSnapshot.val() : null;

    if (familyId) {
      console.log(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ëª¨ë“œ: ${familyId}`);

      // ê°€ì¡± ê³µìœ  ê±°ë˜ ì—…ë°ì´íŠ¸
      const transactionsSnapshot = await get(ref(database, `families/${familyId}/transactions`));

      if (transactionsSnapshot.exists()) {
        const transactions = transactionsSnapshot.val();
        let updateCount = 0;

        for (const [id, transaction] of Object.entries(transactions)) {
          if (transaction.userId === 'user1') {
            await update(ref(database, `families/${familyId}/transactions/${id}`), {
              userId: firebaseId
            });
            updateCount++;
          }
        }

        console.log(`âœ… ê°€ì¡± ê³µìœ  ê±°ë˜ ${updateCount}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
      }

      // ê°€ì¡± ê³µìœ  ê³ ì •ì§€ì¶œ ì—…ë°ì´íŠ¸
      const fixedExpensesSnapshot = await get(ref(database, `families/${familyId}/fixedExpenses`));

      if (fixedExpensesSnapshot.exists()) {
        const fixedExpenses = fixedExpensesSnapshot.val();
        let updateCount = 0;

        for (const [id, expense] of Object.entries(fixedExpenses)) {
          if (expense.userId === 'user1') {
            await update(ref(database, `families/${familyId}/fixedExpenses/${id}`), {
              userId: firebaseId
            });
            updateCount++;
          }
        }

        console.log(`âœ… ê°€ì¡± ê³µìœ  ê³ ì •ì§€ì¶œ ${updateCount}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
      }
    } else {
      console.log('ğŸ‘¤ ê°œì¸ ëª¨ë“œ');

      // ê°œì¸ ê±°ë˜ ì—…ë°ì´íŠ¸
      const transactionsSnapshot = await get(ref(database, `users/${firebaseId}/transactions`));

      if (transactionsSnapshot.exists()) {
        const transactions = transactionsSnapshot.val();
        let updateCount = 0;

        for (const [id, transaction] of Object.entries(transactions)) {
          if (transaction.userId === 'user1') {
            await update(ref(database, `users/${firebaseId}/transactions/${id}`), {
              userId: firebaseId
            });
            updateCount++;
          }
        }

        console.log(`âœ… ê°œì¸ ê±°ë˜ ${updateCount}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
      }

      // ê°œì¸ ê³ ì •ì§€ì¶œ ì—…ë°ì´íŠ¸
      const fixedExpensesSnapshot = await get(ref(database, `users/${firebaseId}/fixedExpenses`));

      if (fixedExpensesSnapshot.exists()) {
        const fixedExpenses = fixedExpensesSnapshot.val();
        let updateCount = 0;

        for (const [id, expense] of Object.entries(fixedExpenses)) {
          if (expense.userId === 'user1') {
            await update(ref(database, `users/${firebaseId}/fixedExpenses/${id}`), {
              userId: firebaseId
            });
            updateCount++;
          }
        }

        console.log(`âœ… ê°œì¸ ê³ ì •ì§€ì¶œ ${updateCount}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
      }
    }

    console.log('ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!');
    console.log('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”: window.location.reload()');

  } catch (error) {
    console.error('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
  }
})();

// =================================================================
// ì—¬ê¸°ê¹Œì§€ ë³µì‚¬
// =================================================================
